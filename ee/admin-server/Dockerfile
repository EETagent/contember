FROM node:20-alpine as builder
WORKDIR /src

COPY package.json yarn.lock .yarnrc.yml	./
COPY .yarn ./.yarn

# GENERATED DO NOT EDIT
# generated by scripts/dev/update-dockerfile.ts
# package.json copy start

COPY ./packages/admin/package.json ././packages/admin/package.json
COPY ./packages/admin-i18n/package.json ././packages/admin-i18n/package.json
COPY ./packages/admin-sandbox/package.json ././packages/admin-sandbox/package.json
COPY ./packages/binding/package.json ././packages/binding/package.json
COPY ./packages/brand/package.json ././packages/brand/package.json
COPY ./packages/client/package.json ././packages/client/package.json
COPY ./packages/client-content/package.json ././packages/client-content/package.json
COPY ./packages/client-content-generator/package.json ././packages/client-content-generator/package.json
COPY ./packages/graphql-builder/package.json ././packages/graphql-builder/package.json
COPY ./packages/graphql-client/package.json ././packages/graphql-client/package.json
COPY ./packages/interface/package.json ././packages/interface/package.json
COPY ./packages/interface-tester/package.json ././packages/interface-tester/package.json
COPY ./packages/layout/package.json ././packages/layout/package.json
COPY ./packages/playground/package.json ././packages/playground/package.json
COPY ./packages/react-auto/package.json ././packages/react-auto/package.json
COPY ./packages/react-binding/package.json ././packages/react-binding/package.json
COPY ./packages/react-binding-ui/package.json ././packages/react-binding-ui/package.json
COPY ./packages/react-board/package.json ././packages/react-board/package.json
COPY ./packages/react-board-dnd-kit/package.json ././packages/react-board-dnd-kit/package.json
COPY ./packages/react-choice-field/package.json ././packages/react-choice-field/package.json
COPY ./packages/react-choice-field-ui/package.json ././packages/react-choice-field-ui/package.json
COPY ./packages/react-client/package.json ././packages/react-client/package.json
COPY ./packages/react-datagrid/package.json ././packages/react-datagrid/package.json
COPY ./packages/react-datagrid-ui/package.json ././packages/react-datagrid-ui/package.json
COPY ./packages/react-dataview/package.json ././packages/react-dataview/package.json
COPY ./packages/react-devbar/package.json ././packages/react-devbar/package.json
COPY ./packages/react-form/package.json ././packages/react-form/package.json
COPY ./packages/react-form-fields-ui/package.json ././packages/react-form-fields-ui/package.json
COPY ./packages/react-i18n/package.json ././packages/react-i18n/package.json
COPY ./packages/react-identity/package.json ././packages/react-identity/package.json
COPY ./packages/react-leaflet-fields-ui/package.json ././packages/react-leaflet-fields-ui/package.json
COPY ./packages/react-multipass-rendering/package.json ././packages/react-multipass-rendering/package.json
COPY ./packages/react-repeater/package.json ././packages/react-repeater/package.json
COPY ./packages/react-repeater-dnd-kit/package.json ././packages/react-repeater-dnd-kit/package.json
COPY ./packages/react-richtext-renderer/package.json ././packages/react-richtext-renderer/package.json
COPY ./packages/react-routing/package.json ././packages/react-routing/package.json
COPY ./packages/react-slots/package.json ././packages/react-slots/package.json
COPY ./packages/react-utils/package.json ././packages/react-utils/package.json
COPY ./packages/ui/package.json ././packages/ui/package.json
COPY ./packages/utilities/package.json ././packages/utilities/package.json
COPY ./packages/vimeo-file-uploader/package.json ././packages/vimeo-file-uploader/package.json
COPY ./packages/vite-plugin/package.json ././packages/vite-plugin/package.json
COPY ./ee/admin-server/package.json ././ee/admin-server/package.json

# package.json copy end
# GENERATED END


RUN yarn install

COPY ./ ./

RUN yarn as:build

FROM node:20-alpine

WORKDIR /src
COPY --from=builder /src/ee/admin-server/dist/ ./

ENV NODE_ENV "production"
ENV CONTEMBER_PORT "4000"
ENV CONTEMBER_PUBLIC_DIR "/src/public"
ENV CONTEMBER_S3_ENDPOINT ""
ENV CONTEMBER_S3_PREFIX ""
ENV CONTEMBER_S3_KEY ""
ENV CONTEMBER_S3_SECRET ""

CMD ["node", "./server/run-admin.js"]
